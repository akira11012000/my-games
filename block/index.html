<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ブロックよけゲーム（じじブロック）</title>
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1f2937, #020617);
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    header {
      padding: 8px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(15,23,42,0.9);
      box-shadow: 0 2px 6px rgba(0,0,0,0.7);
      z-index: 10;
    }

    #title {
      font-size: 0.95rem;
      font-weight: 600;
    }

    #score {
      font-size: 0.95rem;
      font-weight: 600;
    }

    #controls {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 6px 10px;
      background: rgba(15,23,42,0.85);
      box-shadow: 0 2px 6px rgba(0,0,0,0.7);
      z-index: 9;
    }

    #playerRow,
    #difficultyRow {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 2px;
    }

    #playerButtons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .player-btn {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #9ca3af;
      background: #111827;
      color: #e5e7eb;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .player-btn.active {
      background: #facc15;
      color: #111827;
      border-color: #f59e0b;
      font-weight: 700;
    }

    #startBtn {
      padding: 4px 12px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #022c22;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.6);
    }

    #difficultySelect {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #9ca3af;
      background: #111827;
      color: #e5e7eb;
      font-size: 0.8rem;
    }

    #gameContainer {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    canvas {
      display: block;
      background: radial-gradient(circle at top, #0f172a, #020617);
      width: 100%;
      height: 100%;
      touch-action: none;
    }

    /* スマホ用 左右ボタン（サイズ1/2） */
    #touchControls {
      position: fixed;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 16px;
      z-index: 20;
    }

    .move-btn {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      border: none;
      background: radial-gradient(circle at 30% 30%, #e5e7eb, #9ca3af);
      color: #111827;
      font-size: 1.1rem;
      font-weight: 700;
      box-shadow: 0 3px 6px rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
    }

    .move-btn:active {
      transform: scale(0.96);
      box-shadow: 0 2px 4px rgba(0,0,0,0.7);
    }
  </style>
</head>
<body>
  <header>
    <div id="title">ブロックよけゲーム（準備OK）</div>
    <div id="score">スコア: <span id="scoreValue">0</span></div>
  </header>

  <div id="controls">
    <!-- プレイヤー: の文字は削除し、ボタンだけ1行に -->
    <div id="playerRow">
      <div id="playerButtons">
        <button class="player-btn active" data-player="a">プレA</button>
        <button class="player-btn" data-player="b">プレB</button>
        <button class="player-btn" data-player="c">プレC</button>
      </div>
      <button id="startBtn">開始 / 再開</button>
    </div>
    <div id="difficultyRow">
      <span style="font-size:0.8rem;">難易度:</span>
      <select id="difficultySelect">
        <option value="easy">かんたん</option>
        <option value="normal" selected>ふつう</option>
        <option value="hard">むずかしい</option>
      </select>
    </div>
  </div>

  <div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
  </div>

  <!-- スマホ用 左右ボタン -->
  <div id="touchControls">
    <button id="leftBtn" class="move-btn">◀</button>
    <button id="rightBtn" class="move-btn">▶</button>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");
      const scoreValueEl = document.getElementById("scoreValue");
      const startBtn = document.getElementById("startBtn");
      const playerButtons = document.querySelectorAll(".player-btn");
      const gameContainer = document.getElementById("gameContainer");
      const leftBtn = document.getElementById("leftBtn");
      const rightBtn = document.getElementById("rightBtn");
      const difficultySelect = document.getElementById("difficultySelect");

      // プレイヤーをさらに20px上に（110 → 130）
      const BOTTOM_MARGIN = 130;

      // ==== 効果音用 Web Audio ====
      let audioCtx = null;
      function initAudio() {
        if (!audioCtx) {
          const AC = window.AudioContext || window.webkitAudioContext;
          if (AC) {
            audioCtx = new AC();
          }
        }
      }
      function playSound(freq = 440, duration = 0.15, type = "sine", volume = 0.2) {
        if (!audioCtx) return;
        const ctxA = audioCtx;
        const osc = ctxA.createOscillator();
        const gain = ctxA.createGain();
        osc.type = type;
        osc.frequency.value = freq;
        gain.gain.value = volume;
        osc.connect(gain);
        gain.connect(ctxA.destination);
        osc.start();
        osc.stop(ctxA.currentTime + duration);
      }

      const playerImgs = { a: new Image(), b: new Image(), c: new Image() };
      playerImgs.a.src = "player-a.jpeg";
      playerImgs.b.src = "player-b.jpeg";
      playerImgs.c.src = "player-c.jpeg";

      const jijiImg = new Image();
      jijiImg.src = "jiji.PNG";

      let currentPlayerKey = "a";

      const player = {
        x: 0,
        y: 0,
        width: 60,
        height: 60,
        baseSpeed: 3.5   // 速度は 1/2 に調整済み
      };

      function resizeCanvas() {
        const rect = gameContainer.getBoundingClientRect();
        canvas.width = rect.width;
        canvas.height = rect.height;
        player.y = canvas.height - player.height - BOTTOM_MARGIN;
      }

      window.addEventListener("resize", resizeCanvas);

      const blocks = [];
      let blockSpawnInterval = 700;
      let lastSpawnTime = 0;

      const DIFFICULTY_SETTINGS = {
        easy:   { spawnInterval: 900, speedMultiplier: 0.9 },
        normal: { spawnInterval: 700, speedMultiplier: 1.2 },
        hard:   { spawnInterval: 520, speedMultiplier: 1.7 }
      };
      let currentDifficulty = DIFFICULTY_SETTINGS.normal;

      let score = 0;
      let lastTime = 0;
      let running = false;
      let animationId = null;

      const keys = { left: false, right: false };

      document.addEventListener("keydown", function (e) {
        if (e.key === "ArrowLeft" || e.key === "a" || e.key === "A") {
          keys.left = true;
        } else if (e.key === "ArrowRight" || e.key === "d" || e.key === "D") {
          keys.right = true;
        }
      });

      document.addEventListener("keyup", function (e) {
        if (e.key === "ArrowLeft" || e.key === "a" || e.key === "A") {
          keys.left = false;
        } else if (e.key === "ArrowRight" || e.key === "d" || e.key === "D") {
          keys.right = false;
        }
      });

      function setupMoveButton(btn, keyName) {
        btn.addEventListener("mousedown", function () {
          keys[keyName] = true;
        });
        btn.addEventListener("mouseup", function () {
          keys[keyName] = false;
        });
        btn.addEventListener("mouseleave", function () {
          keys[keyName] = false;
        });

        btn.addEventListener("touchstart", function (e) {
          e.preventDefault();
          keys[keyName] = true;
        });
        btn.addEventListener("touchend", function (e) {
          e.preventDefault();
          keys[keyName] = false;
        });
        btn.addEventListener("touchcancel", function (e) {
          e.preventDefault();
          keys[keyName] = false;
        });
      }

      setupMoveButton(leftBtn, "left");
      setupMoveButton(rightBtn, "right");

      playerButtons.forEach(function (btn) {
        btn.addEventListener("click", function () {
          const key = btn.getAttribute("data-player");
          currentPlayerKey = key;
          playerButtons.forEach(function (b) { b.classList.remove("active"); });
          btn.classList.add("active");
        });
      });

      difficultySelect.addEventListener("change", function () {
        const v = difficultySelect.value;
        currentDifficulty = DIFFICULTY_SETTINGS[v] || DIFFICULTY_SETTINGS.normal;
        blockSpawnInterval = currentDifficulty.spawnInterval;
      });

      startBtn.addEventListener("click", function () {
        // iOS 対策：ユーザー操作のタイミングで AudioContext を初期化
        initAudio();
        if (audioCtx && audioCtx.state === "suspended") {
          audioCtx.resume();
        }
        resetGame();
        startGame();
      });

      function clampPlayer() {
        if (player.x < 0) player.x = 0;
        if (player.x + player.width > canvas.width) {
          player.x = canvas.width - player.width;
        }
      }

      function spawnBlock() {
        const r = Math.random();
        let type = "normal";
        if (r < 0.15) {
          type = "jiji";
        } else if (r < 0.55) {
          type = "face";
        }

        const baseFall = 2.5 + Math.random() * 2.5;
        let speed = baseFall * currentDifficulty.speedMultiplier;

        let width, height;
        if (type === "jiji") {
          height = 60;
          width  = 120;
          speed *= 4;
        } else if (type === "face") {
          width = 50;
          height = 50;
          speed *= 2;
        } else {
          width = 40 + Math.random() * 40;
          height = 20 + Math.random() * 20;
        }

        // 全ブロックのスピードを 3/10 に
        speed *= 0.3;

        const x = Math.random() * (canvas.width - width);

        const block = {
          x: x,
          y: -60,
          width: width,
          height: height,
          speed: speed,
          type: type,
          faceKey: null
        };

        if (type === "face") {
          const others = ["a", "b", "c"].filter(function (k) {
            return k !== currentPlayerKey;
          });
          const pk = others[Math.floor(Math.random() * others.length)];
          block.faceKey = pk;
        }

        blocks.push(block);
      }

      function resetGame() {
        if (animationId) cancelAnimationFrame(animationId);
        blocks.length = 0;
        score = 0;
        scoreValueEl.textContent = score;
        lastSpawnTime = 0;
        lastTime = 0;

        const v = difficultySelect.value;
        currentDifficulty = DIFFICULTY_SETTINGS[v] || DIFFICULTY_SETTINGS.normal;
        blockSpawnInterval = currentDifficulty.spawnInterval;

        player.x = canvas.width / 2 - player.width / 2;
        player.y = canvas.height - player.height - BOTTOM_MARGIN;
        running = true;
      }

      function gameOver() {
        running = false;
        if (animationId) cancelAnimationFrame(animationId);
        // 低めのブザー音
        playSound(220, 0.3, "sawtooth", 0.25);
        alert("ゲームオーバー！ スコア: " + score);
      }

      function rectsCollide(a, b) {
        return !(
          a.x + a.width < b.x ||
          a.x > b.x + b.width ||
          a.y + a.height < b.y ||
          a.y > b.y + b.height
        );
      }

      function update(timestamp) {
        if (!running) return;

        if (!lastTime) lastTime = timestamp;
        const delta = timestamp - lastTime;
        lastTime = timestamp;

        const moveSpeed = player.baseSpeed;
        if (keys.left)  player.x -= moveSpeed;
        if (keys.right) player.x += moveSpeed;
        clampPlayer();

        if (timestamp - lastSpawnTime > blockSpawnInterval) {
          spawnBlock();
          lastSpawnTime = timestamp;
        }

        for (let i = blocks.length - 1; i >= 0; i--) {
          const b = blocks[i];
          b.y += b.speed;

          if (rectsCollide(player, b)) {
            gameOver();
            return;
          }

          if (b.y > canvas.height) {
            blocks.splice(i, 1);
            score++;
            scoreValueEl.textContent = score;
            // スコアアップ時の高いピッ音
            playSound(880, 0.1, "square", 0.18);
          }
        }

        draw();
        animationId = requestAnimationFrame(update);
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const pImg = playerImgs[currentPlayerKey];
        if (pImg && pImg.complete) {
          ctx.drawImage(pImg, player.x, player.y, player.width, player.height);
        } else {
          ctx.fillStyle = "#f97316";
          ctx.fillRect(player.x, player.y, player.width, player.height);
        }

        for (let i = 0; i < blocks.length; i++) {
          const b = blocks[i];
          if (b.type === "jiji" && jijiImg.complete) {
            ctx.drawImage(jijiImg, b.x, b.y, b.width, b.height);
          } else if (b.type === "face" && b.faceKey && playerImgs[b.faceKey].complete) {
            ctx.drawImage(playerImgs[b.faceKey], b.x, b.y, b.width, b.height);
          } else {
            ctx.fillStyle = "#38bdf8";
            ctx.fillRect(b.x, b.y, b.width, b.height);
          }
        }
      }

      function startGame() {
        running = true;
        lastTime = 0;
        lastSpawnTime = 0;
        animationId = requestAnimationFrame(update);
      }

      function init() {
        resizeCanvas();
        player.x = canvas.width / 2 - player.width / 2;
        player.y = canvas.height - player.height - BOTTOM_MARGIN;

        const v = difficultySelect.value;
        currentDifficulty = DIFFICULTY_SETTINGS[v] || DIFFICULTY_SETTINGS.normal;
        blockSpawnInterval = currentDifficulty.spawnInterval;

        draw();
      }

      init();
    });
  </script>
</body>
</html>
