<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ブロックよけゲーム（プレイヤー画像＋jiji）</title>
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #1f2937, #020617);
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      touch-action: none;
    }

    header {
      padding: 8px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(15,23,42,0.9);
      box-shadow: 0 2px 6px rgba(0,0,0,0.7);
      z-index: 10;
    }

    #title {
      font-size: 0.95rem;
      font-weight: 600;
    }

    #score {
      font-size: 0.95rem;
      font-weight: 600;
    }

    #controls {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 6px 10px;
      background: rgba(15,23,42,0.85);
      box-shadow: 0 2px 6px rgba(0,0,0,0.7);
      z-index: 9;
    }

    #playerRow,
    #difficultyRow {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      margin-bottom: 2px;
    }

    #playerButtons {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .player-btn {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #9ca3af;
      background: #111827;
      color: #e5e7eb;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .player-btn.active {
      background: #facc15;
      color: #111827;
      border-color: #f59e0b;
      font-weight: 700;
    }

    #startBtn {
      padding: 4px 12px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #022c22;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.6);
    }

    #difficultySelect {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #9ca3af;
      background: #111827;
      color: #e5e7eb;
      font-size: 0.8rem;
    }

    #hint {
      font-size: 0.75rem;
      color: #9ca3af;
    }

    #gameContainer {
      flex: 1;
      position: relative;
      overflow: hidden;
    }

    canvas {
      display: block;
      background: radial-gradient(circle at top, #0f172a, #020617);
      width: 100%;
      height: 100%;
      touch-action: none;
    }

    /* スマホ用 左右ボタン */
    #touchControls {
      position: fixed;
      bottom: 8px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 16px;
      z-index: 20;
    }

    .move-btn {
      width: 64px;
      height: 64px;
      border-radius: 999px;
      border: none;
      background: radial-gradient(circle at 30% 30%, #e5e7eb, #9ca3af);
      color: #111827;
      font-size: 1.8rem;
      font-weight: 700;
      box-shadow: 0 4px 10px rgba(0,0,0,0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
      -webkit-user-select: none;
    }

    .move-btn:active {
      transform: scale(0.96);
      box-shadow: 0 2px 6px rgba(0,0,0,0.7);
    }
  </style>
</head>
<body>
  <header>
    <div id="title">ブロックよけゲーム</div>
    <div id="score">スコア: <span id="scoreValue">0</span></div>
  </header>

  <div id="controls">
    <div id="playerRow">
      <span style="font-size:0.8rem;">プレイヤー:</span>
      <div id="playerButtons">
        <button class="player-btn active" data-player="a">プレイヤー A</button>
        <button class="player-btn" data-player="b">プレイヤー B</button>
        <button class="player-btn" data-player="c">プレイヤー C</button>
      </div>
      <button id="startBtn">スタート / リスタート</button>
    </div>
    <div id="difficultyRow">
      <span style="font-size:0.8rem;">難易度:</span>
      <select id="difficultySelect">
        <option value="easy">かんたん</option>
        <option value="normal" selected>ふつう</option>
        <option value="hard">むずかしい</option>
      </select>
    </div>
    <div id="hint">
      PC: ←→ キーで移動 / スマホ: 下の ◀ ▶ ボタンで移動
    </div>
  </div>

  <div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
  </div>

  <!-- スマホ用 左右ボタン -->
  <div id="touchControls">
    <button id="leftBtn" class="move-btn">◀</button>
    <button id="rightBtn" class="move-btn">▶</button>
  </div>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const scoreValueEl = document.getElementById("scoreValue");
    const startBtn = document.getElementById("startBtn");
    const playerButtons = document.querySelectorAll(".player-btn");
    const gameContainer = document.getElementById("gameContainer");
    const leftBtn = document.getElementById("leftBtn");
    const rightBtn = document.getElementById("rightBtn");
    const difficultySelect = document.getElementById("difficultySelect");

    // プレイヤー画像（A/B/C）
    const playerImageFiles = {
      a: "player-a.jpeg",
      b: "player-b.jpeg",
      c: "player-c.jpeg",
    };

    const playerImgs = {
      a: new Image(),
      b: new Image(),
      c: new Image(),
    };
    playerImgs.a.src = playerImageFiles.a;
    playerImgs.b.src = playerImageFiles.b;
    playerImgs.c.src = playerImageFiles.c;

    // jiji ブロック画像（全プレイヤー共通の危険ブロック）
    const jijiImg = new Image();
    jijiImg.src = "jiji.PNG"; // ファイル名の大文字小文字に注意

    let currentPlayerKey = "a";

    const player = {
      x: 0,
      y: 0,
      width: 60,
      height: 60,
      baseSpeed: 7
    };

    function resizeCanvas() {
      const rect = gameContainer.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;
      player.y = canvas.height - player.height - 10;
    }

    window.addEventListener("resize", resizeCanvas);

    // ブロック一覧
    const blocks = [];
    let blockSpawnInterval = 700;
    let lastSpawnTime = 0;

    // 難易度設定
    const DIFFICULTY_SETTINGS = {
      easy:   { spawnInterval: 900, speedMultiplier: 0.9 },
      normal: { spawnInterval: 700, speedMultiplier: 1.2 },
      hard:   { spawnInterval: 520, speedMultiplier: 1.7 },
    };
    let currentDifficulty = DIFFICULTY_SETTINGS.normal;

    // ゲーム状態
    let score = 0;
    let lastTime = 0;
    let running = false;
    let animationId = null;

    // キーボード操作
    const keys = { left: false, right: false };

    document.addEventListener("keydown", (e) => {
      if (e.key === "ArrowLeft" || e.key === "a" || e.key === "A") {
        keys.left = true;
      } else if (e.key === "ArrowRight" || e.key === "d" || e.key === "D") {
        keys.right = true;
      }
    });

    document.addEventListener("keyup", (e) => {
      if (e.key === "ArrowLeft" || e.key === "a" || e.key === "A") {
        keys.left = false;
      } else if (e.key === "ArrowRight" || e.key === "d" || e.key === "D") {
        keys.right = false;
      }
    });

    // スマホ用 左右ボタン
    function bindMoveButton(btn, keyName) {
      const downEvents = ["touchstart", "mousedown"];
      const upEvents = ["touchend", "touchcancel", "mouseup", "mouseleave"];

      downEvents.forEach(ev => {
        btn.addEventListener(ev, (e) => {
          e.preventDefault();
          keys[keyName] = true;
        }, { passive: false });
      });

      upEvents.forEach(ev => {
        btn.addEventListener(ev, () => {
          keys[keyName] = false;
        });
      });
    }

    bindMoveButton(leftBtn, "left");
    bindMoveButton(rightBtn, "right");

    // プレイヤー選択
    playerButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const key = btn.dataset.player;
        currentPlayerKey = key;

        playerButtons.forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
      });
    });

    // 難易度変更
    difficultySelect.addEventListener("change", () => {
      const v = difficultySelect.value;
      currentDifficulty = DIFFICULTY_SETTINGS[v] || DIFFICULTY_SETTINGS.normal;
      blockSpawnInterval = currentDifficulty.spawnInterval;
    });

    // スタート／リスタート
    startBtn.addEventListener("click", () => {
      resetGame();
      startGame();
    });

    function clampPlayer() {
      if (player.x < 0) player.x = 0;
      if (player.x + player.width > canvas.width) {
        player.x = canvas.width - player.width;
      }
    }

    // ブロック生成
    function spawnBlock() {
      // 3種類：
      //  jijiブロック / 他プレイヤー顔ブロック / 通常ブロック
      const r = Math.random();
      let type = "normal"; // "normal" | "player" | "jiji"

      if (r < 0.15) {
        type = "jiji";
      } else if (r < 0.55) {
        type = "player";
      }

      const baseFall = 2.5 + Math.random() * 2.5;
      let speed = baseFall * currentDifficulty.speedMultiplier;

      let width, height;
      if (type === "jiji") {
        // ★ jiji は横幅を2倍（高さそのまま）
        height = 60;
        width  = 120;      // 横長
        speed *= 4;        // 通常ブロックの4倍、他プレイヤーブロックの2倍
      } else if (type === "player") {
        width = 50;
        height = 50;
        speed *= 2;        // 他プレイヤー顔ブロックは2倍速
      } else {
        width = 40 + Math.random() * 40;
        height = 20 + Math.random() * 20;
      }

      const x = Math.random() * (canvas.width - width);

      const block = {
        x,
        y: -60,
        width,
        height,
        speed,
        kind: type,   // "normal" | "player" | "jiji"
        playerKey: null,
      };

      if (type === "player") {
        // 自分以外のプレイヤーからランダムに選ぶ
        const others = ["a", "b", "c"].filter(k => k !== currentPlayerKey);
        const pk = others[Math.floor(Math.random() * others.length)];
        block.playerKey = pk;
      }

      blocks.push(block);
    }

    function resetGame() {
      cancelAnimationFrame(animationId);
      blocks.length = 0;
      score = 0;
      scoreValueEl.textContent = score;
      lastSpawnTime = 0;
      lastTime = 0;

      const v = difficultySelect.value;
      currentDifficulty = DIFFICULTY_SETTINGS[v] || DIFFICULTY_SETTINGS.normal;
      blockSpawnInterval = currentDifficulty.spawnInterval;

      player.x = canvas.width / 2 - player.width / 2;
      player.y = canvas.height - player.height - 10;
      running = true;
    }

    function gameOver() {
      running = false;
      cancelAnimationFrame(animationId);
      alert("ゲームオーバー！ スコア: " + score);
    }

    function rectsCollide(a, b) {
      return !(
        a.x + a.width < b.x ||
        a.x > b.x + b.width ||
        a.y + a.height < b.y ||
        a.y > b.y + b.height
      );
    }

    function update(timestamp) {
      if (!running) return;

      if (!lastTime) lastTime = timestamp;
      const delta = timestamp - lastTime;
      lastTime = timestamp;

      // プレイヤー移動
      const moveSpeed = player.baseSpeed;
      if (keys.left) {
        player.x -= moveSpeed;
      }
      if (keys.right) {
        player.x += moveSpeed;
      }
      clampPlayer();

      // ブロック生成
      if (timestamp - lastSpawnTime > blockSpawnInterval) {
        spawnBlock();
        lastSpawnTime = timestamp;
      }

      // ブロック更新
      for (let i = blocks.length - 1; i >= 0; i--) {
        const b = blocks[i];
        b.y += b.speed;

        // プレイヤーと衝突？
        if (rectsCollide(player, b)) {
          gameOver();
          return;
        }

        // 画面外に落ちたらスコア加算
        if (b.y > canvas.height) {
          blocks.splice(i, 1);
          score++;
          scoreValueEl.textContent = score;
        }
      }

      draw();
      animationId = requestAnimationFrame(update);
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // プレイヤー（選択中の顔）
      const img = playerImgs[currentPlayerKey];
      if (img && img.complete) {
        ctx.drawImage(img, player.x, player.y, player.width, player.height);
      } else {
        ctx.fillStyle = "#f97316";
        ctx.fillRect(player.x, player.y, player.width, player.height);
      }

      // ブロック描画
      for (const b of blocks) {
        if (b.kind === "jiji" && jijiImg.complete) {
          // ★ 横長 jiji ブロック
          ctx.drawImage(jijiImg, b.x, b.y, b.width, b.height);
        } else if (b.kind === "player" && b.playerKey && playerImgs[b.playerKey].complete) {
          // 他プレイヤー顔ブロック
          ctx.drawImage(playerImgs[b.playerKey], b.x, b.y, b.width, b.height);
        } else {
          // 通常ブロック
          ctx.fillStyle = "#38bdf8";
          ctx.fillRect(b.x, b.y, b.width, b.height);
        }
      }
    }

    function startGame() {
      running = true;
      lastTime = 0;
      lastSpawnTime = 0;
      animationId = requestAnimationFrame(update);
    }

    function init() {
      resizeCanvas();
      player.x = canvas.width / 2 - player.width / 2;
      player.y = canvas.height - player.height - 10;

      currentDifficulty = DIFFICULTY_SETTINGS[difficultySelect.value] || DIFFICULTY_SETTINGS.normal;
      blockSpawnInterval = currentDifficulty.spawnInterval;

      draw();
    }

    init();
  </script>
</body>
</html>
