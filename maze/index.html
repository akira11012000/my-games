<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ëø∑Ë∑Ø„Ç≤„Éº„É†ÔºàÈõ£ÊòìÂ∫¶„Å§„ÅçÔºâ</title>
  <style>
    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #0ea5e9, #020617);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #0f172a;
    }

    .game-wrapper {
      background: #f9fafb;
      border-radius: 18px;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.6);
      padding: 18px 18px 20px;
      width: 95%;
      max-width: 430px;
    }

    h1 {
      margin: 0 0 6px;
      text-align: center;
      font-size: 1.5rem;
      color: #111827;
    }

    .subtitle {
      text-align: center;
      font-size: 0.85rem;
      color: #6b7280;
      margin-bottom: 10px;
      line-height: 1.4;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      flex-wrap: wrap;
    }

    .info-box {
      padding: 6px 10px;
      background: #eef2ff;
      border-radius: 999px;
      font-size: 0.85rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: #4f46e5;
      font-weight: 600;
    }

    .difficulty-box {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.8rem;
    }

    .difficulty-box select {
      font-size: 0.8rem;
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      background: #ffffff;
    }

    .buttons {
      display: flex;
      gap: 6px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.2s;
      white-space: nowrap;
    }

    button:active {
      transform: translateY(1px);
      box-shadow: none;
    }

    #newMazeButton {
      background: #22c55e;
      color: #064e3b;
      box-shadow: 0 3px 10px rgba(34, 197, 94, 0.4);
    }

    #resetPlayerButton {
      background: #e5e7eb;
      color: #374151;
    }

    #mazeCanvas {
      display: block;
      margin: 6px auto 4px;
      background: #f9fafb;
      border-radius: 14px;
      border: 1px solid #1f2937;
    }

    #message {
      text-align: center;
      margin-top: 4px;
      min-height: 1.4em;
      font-size: 0.9rem;
      color: #111827;
    }

    .hint {
      text-align: center;
      margin-top: 4px;
      font-size: 0.75rem;
      color: #6b7280;
    }

    .touch-controls {
      margin-top: 10px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      align-items: center;
    }

    .touch-row {
      display: flex;
      gap: 8px;
      justify-content: center;
    }

    .dir-button {
      width: 64px;
      padding: 8px 0;
      border-radius: 999px;
      border: none;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      background: #e0f2fe;
      color: #0f172a;
      box-shadow: 0 3px 10px rgba(30, 64, 175, 0.35);
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      touch-action: manipulation;
    }

    .dir-button:active {
      transform: translateY(1px);
      box-shadow: none;
      background: #bfdbfe;
    }

    @media (max-width: 480px) {
      .game-wrapper {
        padding: 14px 12px 16px;
      }
      #mazeCanvas {
        width: 100%;
        height: auto;
      }
    }
  </style>
</head>
<body>
  <div class="game-wrapper">
    <h1>Ëø∑Ë∑Ø„Ç≤„Éº„É†</h1>
    <div class="subtitle">
      ‚Üê‚Üë‚Üí‚Üì„Ç≠„Éº „Åæ„Åü„ÅØ ‰∏ã„ÅÆÊñπÂêë„Éú„Çø„É≥„ÅßÁßªÂãï„Åó„Å¶„ÄÅ<br>
      „Çπ„Çø„Éº„Éà„Åã„Çâ„Ç¥„Éº„É´„Åæ„Åß„Åü„Å©„Çä„Å§„Åì„ÅÜÔºÅ
    </div>

    <div class="top-row">
      <div class="info-box">
        üö∂ ÊâãÊï∞Ôºö<span id="stepCount">0</span>
      </div>

      <div class="difficulty-box">
        Èõ£ÊòìÂ∫¶Ôºö
        <select id="difficultySelect">
          <option value="easy">„Åã„Çì„Åü„Çì</option>
          <option value="normal" selected>„Åµ„Å§„ÅÜ</option>
          <option value="hard">„ÇÄ„Åö„Åã„Åó„ÅÑ</option>
        </select>
      </div>

      <div class="buttons">
        <button id="newMazeButton">Êñ∞„Åó„ÅÑËø∑Ë∑Ø</button>
        <button id="resetPlayerButton">„Çπ„Çø„Éº„Éà„Å´Êàª„Çã</button>
      </div>
    </div>

    <canvas id="mazeCanvas" width="360" height="360"></canvas>
    <div id="message"></div>
    <div class="hint">
      Â≠ê„Å©„ÇÇ„ÅÆ„Ç§„É©„Çπ„Éà„Åå„Çπ„Çø„Éº„Éà„ÄÅÈªÑËâ≤„ÅÆÂõõËßí„Åå„Ç¥„Éº„É´„Åß„Åô„ÄÇ
    </div>

    <div class="touch-controls">
      <div class="touch-row">
        <button class="dir-button" id="btnUp">‚Üë</button>
      </div>
      <div class="touch-row">
        <button class="dir-button" id="btnLeft">‚Üê</button>
        <button class="dir-button" id="btnDown">‚Üì</button>
        <button class="dir-button" id="btnRight">‚Üí</button>
      </div>
    </div>
  </div>

  <script>
    // ===== ÂäπÊûúÈü≥ÔºàWeb Audio APIÔºâ =====
    var audioCtx = null;

    function initAudio() {
      if (audioCtx) return;
      try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      } catch (e) {
        audioCtx = null;
      }
    }

    function ensureAudioRunning() {
      if (!audioCtx) return;
      if (audioCtx.state === "suspended") {
        audioCtx.resume();
      }
    }

    function playBeep(freq, duration, type, volume) {
      if (!audioCtx) return;
      ensureAudioRunning();

      var osc = audioCtx.createOscillator();
      var gain = audioCtx.createGain();

      osc.type = type || "square";
      osc.frequency.value = freq || 440;
      gain.gain.value = (typeof volume === "number") ? volume : 0.2;

      osc.connect(gain);
      gain.connect(audioCtx.destination);

      osc.start();
      setTimeout(function () {
        osc.stop();
      }, duration || 150);
    }

    function playMoveSound() {
      playBeep(660, 60, "square", 0.12);
    }

    function playGoalSound() {
      playBeep(660, 120, "square", 0.22);
      setTimeout(function () {
        playBeep(880, 150, "square", 0.22);
      }, 160);
    }

    function playNewMazeSound() {
      playBeep(330, 80, "sine", 0.16);
    }

    // ===== Ëø∑Ë∑ØÊú¨‰Ωì =====
    var canvas = document.getElementById("mazeCanvas");
    var ctx = canvas.getContext("2d");
    var stepCountSpan = document.getElementById("stepCount");
    var message = document.getElementById("message");
    var newMazeButton = document.getElementById("newMazeButton");
    var resetPlayerButton = document.getElementById("resetPlayerButton");
    var difficultySelect = document.getElementById("difficultySelect");

    var btnUp = document.getElementById("btnUp");
    var btnDown = document.getElementById("btnDown");
    var btnLeft = document.getElementById("btnLeft");
    var btnRight = document.getElementById("btnRight");

    // Èõ£ÊòìÂ∫¶„Åî„Å®„ÅÆ„Çµ„Ç§„Ç∫
    var DIFFICULTIES = {
      easy:   { cols: 10, rows: 10 },
      normal: { cols: 15, rows: 15 },
      hard:   { cols: 20, rows: 20 }
    };

    var COLS = 15;
    var ROWS = 15;
    var cellSize = canvas.width / COLS;

    var cells = [];
    var player = { row: 0, col: 0 };
    var goal = { row: ROWS - 1, col: COLS - 1 };
    var stepCount = 0;

    // „Éó„É¨„Ç§„É§„ÉºÁîªÂÉè
    var playerImg = new Image();
    var playerImgLoaded = false;
    playerImg.onload = function () {
      playerImgLoaded = true;
      drawMaze();
    };
    // ‚òÖ player.png ‚Üí player.jpeg „Å´Â§âÊõ¥ ‚òÖ
    playerImg.src = "player.jpeg";

    function applyDifficulty() {
      var key = difficultySelect.value;
      COLS = DIFFICULTIES[key].cols;
      ROWS = DIFFICULTIES[key].rows;
      cellSize = canvas.width / COLS;
      goal = { row: ROWS - 1, col: COLS - 1 };
    }

    // „Çª„É´ÊßãÈÄ†: { visited: bool, walls: {top, right, bottom, left} }
    function createEmptyMaze() {
      cells = [];
      var r, c;
      for (r = 0; r < ROWS; r++) {
        var row = [];
        for (c = 0; c < COLS; c++) {
          row.push({
            visited: false,
            walls: { top: true, right: true, bottom: true, left: true }
          });
        }
        cells.push(row);
      }
    }

    function generateMaze() {
      createEmptyMaze();

      var stack = [];
      var current = { row: 0, col: 0 };
      cells[0][0].visited = true;
      stack.push(current);

      while (stack.length > 0) {
        current = stack[stack.length - 1];
        var unvisitedNeighbors = [];

        var r = current.row;
        var c = current.col;

        if (r > 0 && !cells[r - 1][c].visited) {
          unvisitedNeighbors.push({ row: r - 1, col: c, dir: "top" });
        }
        if (c < COLS - 1 && !cells[r][c + 1].visited) {
          unvisitedNeighbors.push({ row: r, col: c + 1, dir: "right" });
        }
        if (r < ROWS - 1 && !cells[r + 1][c].visited) {
          unvisitedNeighbors.push({ row: r + 1, col: c, dir: "bottom" });
        }
        if (c > 0 && !cells[r][c - 1].visited) {
          unvisitedNeighbors.push({ row: r, col: c - 1, dir: "left" });
        }

        if (unvisitedNeighbors.length === 0) {
          stack.pop();
        } else {
          var nextIndex = Math.floor(Math.random() * unvisitedNeighbors.length);
          var next = unvisitedNeighbors[nextIndex];

          if (next.dir === "top") {
            cells[r][c].walls.top = false;
            cells[next.row][next.col].walls.bottom = false;
          } else if (next.dir === "right") {
            cells[r][c].walls.right = false;
            cells[next.row][next.col].walls.left = false;
          } else if (next.dir === "bottom") {
            cells[r][c].walls.bottom = false;
            cells[next.row][next.col].walls.top = false;
          } else if (next.dir === "left") {
            cells[r][c].walls.left = false;
            cells[next.row][next.col].walls.right = false;
          }

          cells[next.row][next.col].visited = true;
          stack.push({ row: next.row, col: next.col });
        }
      }
    }

    function drawMaze() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      ctx.fillStyle = "#f9fafb";
      ctx.fillRect(0, 0, canvas.width, canvas.height);

      ctx.strokeStyle = "#111827";
      ctx.lineWidth = 2;

      var r, c;
      for (r = 0; r < ROWS; r++) {
        for (c = 0; c < COLS; c++) {
          var x = c * cellSize;
          var y = r * cellSize;
          var cell = cells[r][c];

          ctx.beginPath();
          if (cell.walls.top) {
            ctx.moveTo(x, y);
            ctx.lineTo(x + cellSize, y);
          }
          if (cell.walls.right) {
            ctx.moveTo(x + cellSize, y);
            ctx.lineTo(x + cellSize, y + cellSize);
          }
          if (cell.walls.bottom) {
            ctx.moveTo(x, y + cellSize);
            ctx.lineTo(x + cellSize, y + cellSize);
          }
          if (cell.walls.left) {
            ctx.moveTo(x, y);
            ctx.lineTo(x, y + cellSize);
          }
          ctx.stroke();
        }
      }

      // „Ç¥„Éº„É´
      var gx = goal.col * cellSize;
      var gy = goal.row * cellSize;
      ctx.fillStyle = "#facc15";
      ctx.fillRect(gx + 4, gy + 4, cellSize - 8, cellSize - 8);

      // „Éó„É¨„Ç§„É§„ÉºÔºàÁîªÂÉè or ‰∏∏Ôºâ
      var px = player.col * cellSize;
      var py = player.row * cellSize;

      if (playerImgLoaded) {
        var margin = cellSize * 0.1;
        ctx.drawImage(
          playerImg,
          px + margin,
          py + margin,
          cellSize - margin * 2,
          cellSize - margin * 2
        );
      } else {
        ctx.fillStyle = "#22c55e";
        ctx.beginPath();
        ctx.arc(
          px + cellSize / 2,
          py + cellSize / 2,
          cellSize * 0.3,
          0,
          Math.PI * 2
        );
        ctx.fill();
        ctx.strokeStyle = "#166534";
        ctx.lineWidth = 2;
        ctx.stroke();
      }
    }

    function resetPlayer() {
      player.row = 0;
      player.col = 0;
      stepCount = 0;
      stepCountSpan.innerHTML = "0";
      message.innerHTML = "";
      drawMaze();
    }

    function movePlayer(dr, dc) {
      initAudio();
      ensureAudioRunning();

      var newRow = player.row + dr;
      var newCol = player.col + dc;

      if (newRow < 0 || newRow >= ROWS || newCol < 0 || newCol >= COLS) {
        return;
      }

      var currentCell = cells[player.row][player.col];

      if (dr === -1 && currentCell.walls.top) return;
      if (dr ===  1 && currentCell.walls.bottom) return;
      if (dc === -1 && currentCell.walls.left) return;
      if (dc ===  1 && currentCell.walls.right) return;

      player.row = newRow;
      player.col = newCol;
      stepCount += 1;
      stepCountSpan.innerHTML = String(stepCount);

      drawMaze();

      if (player.row === goal.row && player.col === goal.col) {
        message.innerHTML = "üéâ „Ç¥„Éº„É´ÔºÅ „Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅÔºàÊâãÊï∞Ôºö" + stepCount + "Ôºâ";
        playGoalSound();
      } else {
        message.innerHTML = "";
        playMoveSound();
      }
    }

    document.onkeydown = function(e) {
      e = e || window.event;
      var code = e.keyCode || e.which;
      if (code === 37) {
        movePlayer(0, -1);
      } else if (code === 38) {
        movePlayer(-1, 0);
      } else if (code === 39) {
        movePlayer(0, 1);
      } else if (code === 40) {
        movePlayer(1, 0);
      }
    };

    btnUp.onclick = function() { movePlayer(-1, 0); };
    btnDown.onclick = function() { movePlayer(1, 0); };
    btnLeft.onclick = function() { movePlayer(0, -1); };
    btnRight.onclick = function() { movePlayer(0, 1); };

    newMazeButton.onclick = function() {
      initAudio();
      ensureAudioRunning();
      applyDifficulty();
      generateMaze();
      resetPlayer();
      playNewMazeSound();
    };

    resetPlayerButton.onclick = function() {
      resetPlayer();
    };

    difficultySelect.onchange = function() {
      applyDifficulty();
      generateMaze();
      resetPlayer();
    };

    applyDifficulty();
    generateMaze();
    resetPlayer();
  </script>
</body>
</html>
